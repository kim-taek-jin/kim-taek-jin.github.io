<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodFlix - Hybrid Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .scroll-container { scrollbar-width: none; -ms-overflow-style: none; }
        .scroll-container::-webkit-scrollbar { display: none; }

        /* --- Dark Mode Styles --- */
        body.dark { background-color: #111827; color: #d1d5db; }
        body.dark .bg-white { background-color: #1f2937; }
        body.dark .text-gray-800, body.dark .text-gray-900 { color: #f9fafb; }
        body.dark .text-gray-500, body.dark .text-gray-600 { color: #9ca3af; }
        body.dark .border-gray-200 { border-color: #4b5563; }
        body.dark .nav-tab { color: #9ca3af; }
        body.dark .nav-tab.active { color: #a5b4fc; border-bottom-color: #a5b4fc; }
        body.dark .mood-btn, body.dark .genre-chip, body.dark .region-btn { background-color: #374151; }
        body.dark #userInput { background-color: #374151; border-color: #4b5563; }
        
        /* General Styles */
        .nav-tab { transition: all 0.2s; }
        .nav-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .mood-btn, .genre-chip, .region-btn { transition: all 0.2s; cursor: pointer; }
        .mood-btn:hover, .genre-chip:hover, .region-btn:hover { transform: translateY(-2px); }
        .mood-btn.selected, .genre-chip.selected, .region-btn.selected {
            background-image: linear-gradient(to right, #6366f1, #818cf8);
            color: white;
            border-color: transparent;
            transform: scale(1.05);
        }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="bg-white shadow-sm sticky top-0 z-20">
        <div class="container mx-auto px-4 max-w-6xl">
            <nav class="flex space-x-8">
                <button id="tabRecommender" class="nav-tab py-4 px-1 text-gray-800 font-semibold border-b-2 border-transparent active">ì¶”ì²œ ë°›ê¸°</button>
                <button id="tabCommunity" class="nav-tab py-4 px-1 text-gray-500 font-semibold border-b-2 border-transparent">ì»¤ë®¤ë‹ˆí‹°</button>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div id="recommenderView">
            <div id="now-playing-section" class="mb-12">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">âœ¨ ìš”ì¦˜ ëœ¨ëŠ” ì‹ ì‘ (ì˜í™” & TV)</h2>
                <div class="scroll-container flex overflow-x-auto space-x-6 pb-4"></div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸŒ êµ­ê°€ ì„ íƒ</h2>
                <div class="grid grid-cols-3 gap-4" id="regionSection">
                     <button class="region-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center font-medium selected" data-region="all">ì „ì²´</button>
                     <button class="region-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center font-medium" data-region="KR">í•œêµ­</button>
                     <button class="region-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center font-medium" data-region="foreign">í•´ì™¸</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ˜Š ì§€ê¸ˆ ê¸°ë¶„ì´ ì–´ë– ì‹ ê°€ìš”? (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="moodSection">
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="happy"><div class="text-3xl mb-2">ğŸ˜Š</div><div class="font-medium">ì„¤ë ˆìš”</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="sad"><div class="text-3xl mb-2">ğŸ˜”</div><div class="font-medium">ìš°ìš¸í•´ìš”</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="angry"><div class="text-3xl mb-2">ğŸ˜¡</div><div class="font-medium">í™”ëˆí•˜ê²Œ</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="calm"><div class="text-3xl mb-2">ğŸ˜Œ</div><div class="font-medium">ì”ì”í•˜ê²Œ</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="excited"><div class="text-3xl mb-2">ğŸ¤©</div><div class="font-medium">ì‹ ë‚˜ìš”</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="tired"><div class="text-3xl mb-2">ğŸ˜´</div><div class="font-medium">í”¼ê³¤í•´ìš”</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="romantic"><div class="text-3xl mb-2">ğŸ¥°</div><div class="font-medium">ë¡œë§¨í‹±í•œ</div></div>
                     <div class="mood-btn bg-gray-50 border border-gray-200 rounded-xl p-4 text-center" data-mood="curious"><div class="text-3xl mb-2">ğŸ¤”</div><div class="font-medium">ê¶ê¸ˆí•´ìš”</div></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ­ ì–´ë–¤ ë¶„ìœ„ê¸°ë¥¼ ì›í•˜ì„¸ìš”? (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
                <div class="flex flex-wrap gap-3" id="genreSection">
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="10749">#ë¡œë§¨í‹± ì½”ë¯¸ë””</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="35">#ì½”ë¯¸ë””</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="28">#ì•¡ì…˜</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="12">#ëª¨í—˜</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="16">#ì• ë‹ˆë©”ì´ì…˜</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="80">#ë²”ì£„</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="99">#ë‹¤íë©˜í„°ë¦¬</div>
                    <div class="genre-chip bg-gray-100 px-4 py-2 rounded-full text-sm font-medium" data-genre-id="18">#ë“œë¼ë§ˆ</div>
                </div>
            </div>
            <div class="text-center">
                <button id="getRecommendationBtn" class="bg-indigo-500 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-lg hover:bg-indigo-600 transition">âœ¨ ë‚˜ë§Œì˜ ì¶”ì²œ ë°›ê¸°</button>
            </div>
            <div id="recommendation-title" class="text-center hidden mt-12">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">ğŸ¯ ë‹¹ì‹ ì„ ìœ„í•œ ì¶”ì²œ ê²°ê³¼</h2>
            </div>
            <div id="loadingSection" class="hidden text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>
            <div id="recommendationSection" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-8"></div>
        </div>

        <div id="communityView" class="hidden">
            </div>
    </div>
    
    <div id="allModals"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const API_KEY = '84a28355dfa66f454298d9752c6851ae';
        const API_BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const POSTS_STORAGE_KEY = 'moodflix_community_posts_v3';
        const moodToGenreMap = { happy: [10749, 35], sad: [18, 10751], angry: [28, 53], calm: [99, 36], excited: [12, 80], tired: [10752, 16], romantic: [10749], curious: [9648, 878] };
        const EXCLUDE_KEYWORDS = '6290,2985,10377'; 

        // --- NEW: Local Content Database ---
        const localContentDatabase = [
            {
                id: 'local_1',
                title: 'ê¸°ìƒì¶©',
                poster_path: '/gLhYgI4T2tIPpSo61IAGPeOcg27.jpg',
                vote_average: 8.5,
                overview: 'ì „ì›ë°±ìˆ˜ë¡œ ì‚´ ê¸¸ ë§‰ë§‰í•˜ì§€ë§Œ ì‚¬ì´ëŠ” ì¢‹ì€ ê¸°íƒ(ì†¡ê°•í˜¸) ê°€ì¡±...',
                release_date: '2019-05-30',
                genre_ids: [35, 18, 53], // ì½”ë¯¸ë””, ë“œë¼ë§ˆ, ìŠ¤ë¦´ëŸ¬
                is_local: true
            },
            {
                id: 'local_2',
                title: 'ê·¹í•œì§ì—…',
                poster_path: '/v3QyboPM4lE1vTzOc291E8kYy4S.jpg',
                vote_average: 7.4,
                overview: 'ë¶ˆì² ì£¼ì•¼ ë‹¬ë¦¬ê³  êµ¬ë¥´ì§€ë§Œ ì‹¤ì ì€ ë°”ë‹¥, í•´ì²´ ìœ„ê¸°ë¥¼ ë§ëŠ” ë§ˆì•½ë°˜...',
                release_date: '2019-01-23',
                genre_ids: [28, 80, 35], // ì•¡ì…˜, ë²”ì£„, ì½”ë¯¸ë””
                is_local: true
            }
        ];

        // --- GLOBAL STATE & SELECTORS ---
        let selectedMood = null;
        let selectedGenres = [];
        let selectedRegion = 'all'; 
        let posts = [];
        let currentMovieTitles = new Set();
        let searchTimeout;
        const recommenderView = document.getElementById('recommenderView');
        const communityView = document.getElementById('communityView');
        const tabRecommender = document.getElementById('tabRecommender');
        const tabCommunity = document.getElementById('tabCommunity');
        const nowPlayingSection = document.querySelector('#now-playing-section .scroll-container');
        const moodSection = document.getElementById('moodSection');
        const genreSection = document.getElementById('genreSection');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn');
        const recommendationSection = document.getElementById('recommendationSection');
        const recommendationTitle = document.getElementById('recommendation-title');
        const loadingSection = document.getElementById('loadingSection');
        const allModalsContainer = document.getElementById('allModals');
        const regionSection = document.getElementById('regionSection');
        
        // --- MODAL SETUP (omitted for brevity) ---
        function setupModals() { /* ... unchanged ... */ }

        // --- API Functions ---
        async function fetchAPI(url) { try { const r = await fetch(url); if (!r.ok) throw new Error(`E: ${r.statusText}`); return await r.json(); } catch (e) { console.error("API Fetch Error:", e); return null; } }
        async function fetchNowPlaying() { /* ... unchanged ... */ }

        // --- UPDATED: fetchRecommendations to be Hybrid ---
        async function fetchRecommendations(genreIdString, regionQueryString) {
            loadingSection.classList.remove('hidden');
            recommendationSection.innerHTML = '';
            recommendationTitle.classList.add('hidden');

            // 1. Fetch from API
            const url = `${API_BASE_URL}/discover/movie?api_key=${API_KEY}&language=ko-KR&sort_by=popularity.desc&with_genres=${genreIdString}&page=1&include_adult=false&without_keywords=${EXCLUDE_KEYWORDS}${regionQueryString}`;
            const apiPromise = fetchAPI(url);

            // 2. Filter local database
            let localResults = [];
            if (selectedRegion === 'all' || selectedRegion === 'KR') {
                const selectedGenreIds = genreIdString.split(',').map(id => parseInt(id, 10));
                localResults = localContentDatabase.filter(movie => 
                    selectedGenreIds.some(id => movie.genre_ids.includes(id))
                );
            }
            
            const apiData = await apiPromise;
            const apiResults = apiData?.results || [];

            // 3. Combine and remove duplicates (local data takes priority)
            const combinedResults = [...localResults, ...apiResults];
            const uniqueResults = Array.from(new Map(combinedResults.map(item => [item.title, item])).values());
            
            loadingSection.classList.add('hidden');
            displayRecommendations(uniqueResults);
        }
        
        async function fetchSearch(query) { /* ... unchanged ... */ }

        // --- Display & UI Functions (omitted for brevity) ---
        function displayNowPlaying(items) { /* ... unchanged ... */ }
        function displayRecommendations(movies) { /* ... unchanged ... */ }
        function displaySearchResults(results) { /* ... unchanged ... */ }

        // --- All other functions and event listeners ---
        // (Full code for setupModals, display functions, tabs, modals, community, etc., is included below)
        function setupModals() { allModalsContainer.innerHTML = `<div id="writePostModal" class="modal-overlay fixed inset-0 z-30 hidden items-center justify-center p-4"><div class="modal-content bg-white w-full max-w-2xl rounded-lg shadow-lg p-6 opacity-0 -translate-y-8"><h2 class="text-2xl font-bold mb-4 text-gray-800">ê°ìƒí‰ ì‘ì„±</h2><form id="postForm"><input type="hidden" id="selectedContentTitle" required><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">ì½˜í…ì¸  ê²€ìƒ‰</label><div id="selectedContentDisplay" class="hidden mb-2 p-2 bg-indigo-100 rounded text-indigo-800 font-semibold"></div><input type="search" id="movieSearchInput" class="w-full p-2 border border-gray-300 rounded" placeholder="ì˜í™” ë˜ëŠ” TV ë“œë¼ë§ˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..."><div id="searchResults" class="mt-2 max-h-60 overflow-y-auto border border-gray-200 rounded"></div></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">ì œëª©</label><input type="text" id="postTitle" class="w-full p-2 border border-gray-300 rounded" required></div><div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">ë‚´ìš©</label><textarea id="postContent" rows="6" class="w-full p-2 border border-gray-300 rounded" required></textarea></div><div class="flex items-center justify-end space-x-4"><button type="button" class="close-modal-btn bg-gray-200 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button><button type="submit" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded">ì €ì¥</button></div></form></div></div><div id="viewPostModal" class="modal-overlay fixed inset-0 z-30 hidden items-center justify-center p-4"><div class="modal-content bg-white w-full max-w-2xl rounded-lg shadow-lg p-8 opacity-0 -translate-y-8"><h2 id="viewPostTitle" class="text-3xl font-bold mb-2"></h2><p id="viewPostContentTitle" class="text-lg font-semibold text-indigo-500 mb-4"></p><p id="viewPostDate" class="text-sm text-gray-500 mb-6"></p><div id="viewPostContent" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div><div class="text-right mt-8"><button class="close-modal-btn bg-gray-200 font-bold py-2 px-4 rounded">ë‹«ê¸°</button></div></div></div>`; document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay')))); document.getElementById('postForm').addEventListener('submit', handlePostSubmit); const movieSearchInput = document.getElementById('movieSearchInput'); movieSearchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { const query = movieSearchInput.value; if (query.length > 1) { fetchSearch(query); } else { document.getElementById('searchResults').innerHTML = ''; } }, 500); }); }
        async function fetchNowPlaying() { const movieUrl = `${API_BASE_URL}/movie/now_playing?api_key=${API_KEY}&language=ko-KR&page=1&region=KR`; const tvUrl = `${API_BASE_URL}/tv/on_the_air?api_key=${API_KEY}&language=ko-KR&page=1`; try { const [movieData, tvData] = await Promise.all([ fetchAPI(movieUrl), fetchAPI(tvUrl) ]); const normMovies = (movieData?.results || []).map(i => ({ ...i, type: 'movie' })); const normTvs = (tvData?.results || []).map(i => ({ ...i, title: i.name, release_date: i.first_air_date, type: 'tv' })); const combined = [...normMovies, ...normTvs].sort((a, b) => b.popularity - a.popularity); displayNowPlaying(combined); } catch (e) { console.error("Fetch Now Playing/On Air Error:", e); nowPlayingSection.innerHTML = `<p class="text-red-500">ì½˜í…ì¸  ë¡œë”© ì‹¤íŒ¨</p>`; } }
        async function fetchSearch(query) { const url = `${API_BASE_URL}/search/multi?api_key=${API_KEY}&language=ko-KR&query=${encodeURIComponent(query)}&include_adult=false`; const data = await fetchAPI(url); if (data && data.results) displaySearchResults(data.results); }
        function displayNowPlaying(items) { nowPlayingSection.innerHTML = ''; items.filter(i => i.poster_path).slice(0, 10).forEach(i => { currentMovieTitles.add(i.title); const c = document.createElement('div'); c.className = 'flex-shrink-0 w-48 bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform'; c.innerHTML = `<img src="${IMAGE_BASE_URL}${i.poster_path}" class="w-full h-64 object-cover"><div class="p-4"><h3 class="font-bold text-md truncate text-gray-800">${i.title}</h3><p class="text-sm text-gray-600">â­ ${i.vote_average.toFixed(1)}</p></div>`; nowPlayingSection.appendChild(c); }); }
        function displayRecommendations(movies) { recommendationSection.innerHTML = ''; if (movies.length > 0) { recommendationTitle.classList.remove('hidden'); } else { recommendationSection.innerHTML = `<p class="text-center text-gray-500">ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ì˜í™”ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¥</p>`; } movies.slice(0, 8).forEach((m, i) => { currentMovieTitles.add(m.title); const c = document.createElement('div'); c.className = 'bg-white rounded-lg shadow-md overflow-hidden'; const poster = m.poster_path ? `<img src="${IMAGE_BASE_URL}${m.poster_path}" class="w-full h-80 object-cover">` : `<div class="w-full h-80 bg-gray-200 flex items-center justify-center text-6xl">ğŸ¬</div>`; c.innerHTML = `${poster}<div class="p-4"><h3 class="font-bold text-lg truncate text-gray-800">${m.title}</h3><p class="text-sm text-gray-600">${m.release_date || ''}</p><p class="text-sm text-gray-600">â­ ${m.vote_average.toFixed(1)}</p></div>`; recommendationSection.appendChild(c); }); }
        function displaySearchResults(results) { const cont = document.getElementById('searchResults'); cont.innerHTML = ''; results.filter(r => (r.media_type === 'movie' || r.media_type === 'tv') && r.poster_path).slice(0, 5).forEach(i => { const itemEl = document.createElement('div'); itemEl.className = 'p-2 flex items-center hover:bg-gray-100 cursor-pointer'; const title = i.media_type === 'movie' ? i.title : i.name; const date = i.media_type === 'movie' ? i.release_date : i.first_air_date; itemEl.innerHTML = `<img src="${IMAGE_BASE_URL}${i.poster_path}" class="w-10 h-14 object-cover mr-4 rounded"><div><div class="font-bold">${title}</div><div class="text-sm text-gray-500">${date ? date.split('-')[0] : ''}</div></div>`; itemEl.addEventListener('click', () => { document.getElementById('selectedContentTitle').value = title; document.getElementById('selectedContentDisplay').textContent = `ì„ íƒë¨: ${title}`; document.getElementById('selectedContentDisplay').classList.remove('hidden'); document.getElementById('movieSearchInput').value = ''; cont.innerHTML = ''; }); cont.appendChild(itemEl); }); }
        function switchTab(activeTab) { if (activeTab === 'recommender') { recommenderView.classList.remove('hidden'); communityView.classList.add('hidden'); tabRecommender.classList.add('active'); tabCommunity.classList.remove('active'); } else { recommenderView.classList.add('hidden'); communityView.classList.remove('hidden'); tabRecommender.classList.remove('active'); tabCommunity.classList.add('active'); loadPosts(); } }
        function openModal(modal) { modal.classList.remove('hidden'); setTimeout(() => modal.querySelector('.modal-content').classList.remove('opacity-0', '-translate-y-8'), 10); }
        function closeModal(modal) { modal.querySelector('.modal-content').classList.add('opacity-0', '-translate-y-8'); setTimeout(() => { modal.classList.add('hidden'); if(modal.id === 'writePostModal') { document.getElementById('postForm').reset(); document.getElementById('searchResults').innerHTML = ''; document.getElementById('selectedContentDisplay').classList.add('hidden'); } }, 300); }
        function loadPosts() { const stored = localStorage.getItem(POSTS_STORAGE_KEY); posts = stored ? JSON.parse(stored) : []; renderPosts(); }
        function savePosts() { localStorage.setItem(POSTS_STORAGE_KEY, JSON.stringify(posts)); }
        function renderPosts(filter = 'all') { const postList = document.getElementById('postList'); const filterSelect = document.getElementById('filterSelect'); if(!postList || !filterSelect) return; const allTitles = new Set(posts.map(p => p.contentTitle)); populateSelectWithOptions(filterSelect, Array.from(allTitles), true); filterSelect.value = filter; const toRender = (filter === 'all') ? posts : posts.filter(p => p.contentTitle === filter); postList.innerHTML = ''; if(toRender.length === 0) { postList.innerHTML = `<div class="text-center text-gray-500 py-10">ê°ìƒí‰ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; } toRender.forEach(p => { const item = document.createElement('div'); item.className = 'bg-white p-5 rounded-lg shadow-md cursor-pointer'; item.innerHTML = `<p class="text-sm font-semibold text-indigo-500">#${p.contentTitle}</p><h3 class="text-xl font-bold text-gray-800">${p.title}</h3>`; item.addEventListener('click', () => { document.getElementById('viewPostTitle').textContent = p.title; document.getElementById('viewPostContentTitle').textContent = `#${p.contentTitle}`; document.getElementById('viewPostDate').textContent = `ì‘ì„±ì¼: ${p.date}`; document.getElementById('viewPostContent').textContent = p.content; openModal(document.getElementById('viewPostModal')); }); postList.appendChild(item); }); }
        function handlePostSubmit(e) { e.preventDefault(); const selectedTitle = document.getElementById('selectedContentTitle').value; if (!selectedTitle) { alert('ë¨¼ì € ì½˜í…ì¸ ë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•´ì£¼ì„¸ìš”.'); return; } const newPost = { id: Date.now(), contentTitle: selectedTitle, title: document.getElementById('postTitle').value, content: document.getElementById('postContent').value, date: new Date().toLocaleDateString() }; posts.unshift(newPost); savePosts(); renderPosts(); closeModal(document.getElementById('writePostModal')); }
        function populateSelectWithOptions(select, options, includeAll = false) { if(!select) return; select.innerHTML = ''; if(includeAll) select.innerHTML += `<option value="all">ëª¨ë“  ì½˜í…ì¸  ê¸€ ë³´ê¸°</option>`; else select.innerHTML += `<option value="" disabled selected>ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>`; options.sort().forEach(o => select.innerHTML += `<option value="${o}">${o}</option>`); }
        tabRecommender.addEventListener('click', () => switchTab('recommender'));
        tabCommunity.addEventListener('click', () => switchTab('community'));
        regionSection.addEventListener('click', (e) => { const btn = e.target.closest('.region-btn'); if (!btn) return; document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); selectedRegion = btn.dataset.region; });
        moodSection.addEventListener('click', (e) => { const btn = e.target.closest('.mood-btn'); if(!btn) return; if (btn.classList.contains('selected')) { btn.classList.remove('selected'); selectedMood = null; } else { document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); selectedMood = btn.dataset.mood; } });
        genreSection.addEventListener('click', (e) => { const chip = e.target.closest('.genre-chip'); if(!chip) return; chip.classList.toggle('selected'); const id = chip.dataset.genreId; if(selectedGenres.includes(id)) selectedGenres = selectedGenres.filter(g => g !== id); else selectedGenres.push(id); });
        getRecommendationBtn.addEventListener('click', () => { const ids = new Set(); if (selectedMood) { (moodToGenreMap[selectedMood] || []).forEach(id => ids.add(id.toString())); } selectedGenres.forEach(id => ids.add(id)); const finalIds = Array.from(ids); if (finalIds.length === 0) { alert('ê¸°ë¶„ì´ë‚˜ ì¥ë¥´ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; } let regionQuery = ''; if (selectedRegion === 'KR') { regionQuery = '&with_origin_country=KR'; } else if (selectedRegion === 'foreign') { regionQuery = '&with_origin_country=US|GB|JP|FR|DE|IN|CA'; } fetchRecommendations(finalIds.join(','), regionQuery); });
        document.getElementById('openWriteModalBtn').addEventListener('click', () => openModal(document.getElementById('writePostModal')));
        document.getElementById('filterSelect').addEventListener('change', (e) => renderPosts(e.target.value));
        setupModals();
        fetchNowPlaying();
    });
    </script>
</body>
</html>